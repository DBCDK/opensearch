/*
 * 
 */

package dk.dbc.opensearch.common.compass;

import dk.dbc.opensearch.common.helpers.OpensearchNamespaceContext;
import java.io.BufferedInputStream;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.util.HashMap;
import java.util.Set;
import javax.xml.namespace.NamespaceContext;
import javax.xml.xpath.XPathExpression;
import org.junit.Before;
import org.junit.Test;
import org.junit.Ignore;
import static org.junit.Assert.*;

/**
 * \Todo: The test contains ignored test cases, see bug 10708
 */
public class PhraseMapTest {

    static NamespaceContext nsc = new OpensearchNamespaceContext();
    
    static private String cpmData = "<?xml version=\"1.0\"?><!DOCTYPE compass-core-mapping PUBLIC \"-//Compass/Compass Core Mapping DTD 2.0//EN\" \"http://www.compass-project.org/dtd/compass-core-mapping-2.2.dtd\"><compass-core-mapping><xml-object alias=\"docbook\" sub-index=\"opensearch-index\"><xml-id name=\"id\" xpath=\"/ting:container/ting:fedoraPid\"/><xml-property name=\"rec.id\" xpath=\"/ting:container/dkabm:record/ac:identifier | /ting:container/ting:fedoraPid\" value-converter=\"default\"/><xml-property name=\"dc.title\" xpath=\"/ting:container/docbook:article/docbook:title | /ting:container/dkabm:record/dcterms:alternative\" value-converter=\"default\"/><xml-property name=\"dc.creator\" xpath=\"/ting:container/docbook:article/docbook:info/docbook:author/docbook:personname/* | /ting:container/dkabm:record/dc:creator | /ting:container/dkabm:record/dc:contributor\" value-converter=\"default\"/><xml-property name=\"cql.anyIndexes\" xpath=\"/ting:container/docbook:article/docbook:title | /ting:container/docbook:article/docbook:info/docbook:abstract/docbook:para | /ting:container/docbook:article/docbook:info/docbook:subjectset/docbook:subject/docbook:subjectterm | /ting:container/docbook:article/docbook:section/docbook:title | /ting:container/docbook:article/docbook:section/docbook:para\" value-converter=\"default\"/><xml-property name=\"dc.description\" xpath=\"/ting:container/docbook:article/docbook:info/docbook:abstract/docbook:para\" value-converter=\"default\"/><xml-property name=\"dc.subject\" xpath=\"/ting:container/docbook:article/docbook:info/docbook:subjectset/docbook:subject/docbook:subjectterm | /ting:container/dkabm:record/dc:subject\" value-converter=\"default\"/><xml-property name=\"dc.type\" xpath=\"/ting:container/dkabm:record/dc:type\" value-converter=\"default\"/><xml-property name=\"dc.format\" xpath=\"/ting:container/dkabm:record/dc:format | /ting:container/dkabm:record/dcterms:extent\" value-converter=\"default\"/><xml-property name=\"dc.language\" xpath=\"/ting:container/dkabm:record/dc:language\" value-converter=\"default\"/><xml-property name=\"dc.date\" xpath=\"/ting:container/dkabm:record/dc:date\" value-converter=\"default\"/><xml-property name=\"dc.identifier\" xpath=\"/ting:container/dkabm:record/dc:identifier\" value-converter=\"default\"/><xml-property name=\"dc.publisher\" xpath=\"/ting:container/dkabm:record/dc:publisher\" value-converter=\"default\"/><xml-property name=\"ac.source\" xpath=\"/ting:container/dkabm:record/ac:source | ting:container/format\" value-converter=\"default\"/><xml-property name=\"phrase.title\" xpath=\"/ting:container/docbook:article/docbook:title | /ting:container/dkabm:record/dcterms:alternative\" index=\"un_tokenized\" value-converter=\"phrase\"/><xml-property name=\"phrase.creator\" xpath=\"/ting:container/docbook:article/docbook:info/docbook:author/docbook:personname/* | /ting:container/dkabm:record/dc:creator | /ting:container/dkabm:record/dc:contributor\" index=\"un_tokenized\" value-converter=\"phrase\"/><xml-property name=\"phrase.anyIndexes\" xpath=\"/ting:container/docbook:article/docbook:title | /ting:container/docbook:article/docbook:info/docbook:abstract/docbook:para | /ting:container/docbook:article/docbook:info/docbook:subjectset/docbook:subject/docbook:subjectterm | /ting:container/docbook:article/docbook:section/docbook:title | /ting:container/docbook:article/docbook:section/docbook:para\" index=\"un_tokenized\" value-converter=\"phrase\"/><xml-property name=\"phrase.description\" xpath=\"/ting:container/docbook:article/docbook:info/docbook:abstract/docbook:para\" index=\"un_tokenized\" value-converter=\"phrase\"/><xml-property name=\"phrase.subject\" xpath=\"/ting:container/docbook:article/docbook:info/docbook:subjectset/docbook:subject/docbook:subjectterm | /ting:container/dkabm:record/dc:subject\" index=\"un_tokenized\" value-converter=\"phrase\"/><xml-property name=\"phrase.type\" xpath=\"/ting:container/dkabm:record/dc:type\" index=\"un_tokenized\" value-converter=\"phrase\"/><xml-property name=\"phrase.language\" xpath=\"/ting:container/dkabm:record/dc:language\" index=\"un_tokenized\" value-converter=\"phrase\"/><xml-property name=\"phrase.date\" xpath=\"/ting:container/dkabm:record/dc:date\" index=\"un_tokenized\" value-converter=\"phrase\"/><xml-property name=\"phrase.source\" xpath=\"/ting:container/dkabm:record/dc:source\" index=\"un_tokenized\" value-converter=\"phrase\"/><xml-property name=\"phrase.identifier\" xpath=\"/ting:container/dkabm:record/dc:identifier\" index=\"un_tokenized\" value-converter=\"phrase\"/><xml-property name=\"phrase.publisher\" xpath=\"/ting:container/dkabm:record/dc:publisher\" index=\"un_tokenized\" value-converter=\"phrase\"/><xml-property name=\"facet.creator\" xpath=\"/ting:container/dkabm:record/dc:creator[not(@xsi:type='oss:sort')] | /ting:container/dkabm:record/dc:contributor\" index=\"un_tokenized\" value-converter=\"facet\"/><xml-property name=\"facet.type\" xpath=\"/ting:container/dkabm:record/dc:type\" index=\"un_tokenized\" value-converter=\"facet\"/><xml-property name=\"facet.subject\" xpath=\"/ting:container/dkabm:record/dc:subject[not(@xsi:type='dkdcplus:DK5')]\" index=\"un_tokenized\" value-converter=\"facet\"/><xml-property name=\"facet.date\" xpath=\"/ting:container/dkabm:record/dc:date\" index=\"un_tokenized\" value-converter=\"facet\"/><xml-property name=\"facet.language\" xpath=\"/ting:container/dkabm:record/dc:language[not(@*)]\" index=\"un_tokenized\" value-converter=\"facet\"/><xml-property name=\"facet.geographic\" xpath=\"/ting:container/dkabm:record/dcterms:spatial\" index=\"un_tokenized\" value-converter=\"facet\"/><xml-property name=\"facet.period\" xpath=\"/ting:container/dkabm:record/dcterms:temporal\" index=\"un_tokenized\" value-converter=\"facet\"/><xml-property name=\"facet.fiction\" xpath=\"/ting:container/dkabm:record/dc:subject[@xsi:type='dkdcplus:DBCS']\" index=\"un_tokenized\" value-converter=\"facet\"/><xml-property name=\"facet.nonFiction\" xpath=\"/ting:container/dkabm:record/dc:subject[@xsi:type='dkdcplus:DBCF']\" index=\"un_tokenized\" value-converter=\"facet\"/><xml-property name=\"facet.music\" xpath=\"/ting:container/dkabm:record/dc:subject[@xsi:type='dkdcplus:DBCM']\" index=\"un_tokenized\" value-converter=\"facet\"/><xml-property name=\"facet.dk5\" xpath=\"/ting:container/dkabm:record/dc:subject[@xsi:type='dkdcplus:DK5']\" index=\"un_tokenized\" value-converter=\"facet\"/><xml-property name=\"sort.date\" xpath=\"/ting:container/dkabm:record/dc:date[1]\" index=\"un_tokenized\" value-converter=\"sort\"/><xml-property name=\"sort.creator\" xpath=\"/ting:container/dkabm:record/dc:creator[@xsi:type='oss:sort'][1]\" index=\"un_tokenized\" value-converter=\"sort\"/><xml-property name=\"sort.title\" xpath=\"/ting:container/dkabm:record/dc:title[1]\" index=\"un_tokenized\" value-converter=\"sort\"/><xml-property name=\"creator\" xpath=\"/ting:container/dkabm:record/dc:creator | /ting:container/dkabm:record/dc:contributor\" index=\"un_tokenized\" value-converter=\"facet\"/><xml-property name=\"date\" xpath=\"/ting:container/dkabm:record/dc:date\" index=\"un_tokenized\" value-converter=\"facet\"/><xml-property name=\"description\" xpath=\"/ting:container/dkabm:record/dc:description | /ting:container/dkabm:record/dcterms:abstract\" index=\"un_tokenized\" value-converter=\"facet\"/><xml-property name=\"format\" xpath=\"/ting:container/dkabm:record/dc:format | /ting:container/dkabm:record/dcterms:extent\" index=\"un_tokenized\" value-converter=\"facet\"/><xml-property name=\"identifier\" xpath=\"/ting:container/dkabm:record/dc:identifier\" index=\"un_tokenized\" value-converter=\"facet\"/><xml-property name=\"language\" xpath=\"/ting:container/dkabm:record/dc:language[not(@*)]\" index=\"un_tokenized\" value-converter=\"facet\"/><xml-property name=\"publisher\" xpath=\"/ting:container/dkabm:record/dc:publisher\" index=\"un_tokenized\" value-converter=\"facet\"/><xml-property name=\"source\" xpath=\"/ting:container/dkabm:record/dc:source | /ting:container/dkabm:record/dcterms:isPartOf\" index=\"un_tokenized\" value-converter=\"facet\"/><xml-property name=\"subject\" xpath=\"/ting:container/dkabm:record/dc:subject\" index=\"un_tokenized\" value-converter=\"facet\"/><xml-property name=\"title\" xpath=\"/ting:container/dkabm:record/dc:title\" index=\"un_tokenized\" value-converter=\"facet\"/><xml-property name=\"type\" xpath=\"/ting:container/dkabm:record/dc:type\" index=\"un_tokenized\" value-converter=\"facet\"/><xml-property name=\"relation\" xpath=\"/ting:container/dkabm:record/dc:relation\" index=\"un_tokenized\" value-converter=\"facet\"/><xml-property name=\"rights\" xpath=\"/ting:container/dkabm:record/dc:rights\" index=\"un_tokenized\" value-converter=\"facet\"/><xml-property xpath=\"/ting:container/ting:fedoraPid\" index=\"un_tokenized\"/><xml-property xpath=\"/ting:container/ting:fedoraNormPid\" index=\"un_tokenized\"/><xml-property xpath=\"/ting:container/ting:original_format\" index=\"un_tokenized\"/><xml-property xpath=\"/ting:container/ting:submitter\" index=\"un_tokenized\"/></xml-object></compass-core-mapping>";
    String cpmFileName;
    String tempFileName;

    static private String  expectedCpm = "<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?><!DOCTYPE compass-core-mapping PUBLIC \"-//Compass/Compass Core Mapping DTD 2.0//EN\" \"http://www.compass-project.org/dtd/compass-core-mapping-2.2.dtd\">\n<compass-core-mapping><xml-object alias=\"docbook\" spell-check=\"na\" sub-index=\"opensearch-index\"><xml-id name=\"id\" omit-norms=\"true\" omit-tf=\"true\" spell-check=\"na\" xpath=\"/ting:container/ting:fedoraPid\"/><xml-property name=\"rec.id\" override=\"true\" reverse=\"no\" spell-check=\"na\" value-converter=\"default\" xpath=\"/ting:container/dkabm:record/ac:identifier | /ting:container/ting:fedoraPid\"/><xml-property name=\"dc.title\" override=\"true\" reverse=\"no\" spell-check=\"na\" value-converter=\"default\" xpath=\"/ting:container/docbook:article/docbook:title | /ting:container/dkabm:record/dcterms:alternative\"/><xml-property name=\"dc.creator\" override=\"true\" reverse=\"no\" spell-check=\"na\" value-converter=\"default\" xpath=\"/ting:container/docbook:article/docbook:info/docbook:author/docbook:personname/* | /ting:container/dkabm:record/dc:creator | /ting:container/dkabm:record/dc:contributor\"/><xml-property name=\"cql.anyIndexes\" override=\"true\" reverse=\"no\" spell-check=\"na\" value-converter=\"default\" xpath=\"/ting:container/docbook:article/docbook:title | /ting:container/docbook:article/docbook:info/docbook:abstract/docbook:para | /ting:container/docbook:article/docbook:info/docbook:subjectset/docbook:subject/docbook:subjectterm | /ting:container/docbook:article/docbook:section/docbook:title | /ting:container/docbook:article/docbook:section/docbook:para\"/><xml-property name=\"dc.description\" override=\"true\" reverse=\"no\" spell-check=\"na\" value-converter=\"default\" xpath=\"/ting:container/docbook:article/docbook:info/docbook:abstract/docbook:para\"/><xml-property name=\"dc.subject\" override=\"true\" reverse=\"no\" spell-check=\"na\" value-converter=\"default\" xpath=\"/ting:container/docbook:article/docbook:info/docbook:subjectset/docbook:subject/docbook:subjectterm | /ting:container/dkabm:record/dc:subject\"/><xml-property name=\"dc.type\" override=\"true\" reverse=\"no\" spell-check=\"na\" value-converter=\"default\" xpath=\"/ting:container/dkabm:record/dc:type\"/><xml-property name=\"dc.format\" override=\"true\" reverse=\"no\" spell-check=\"na\" value-converter=\"default\" xpath=\"/ting:container/dkabm:record/dc:format | /ting:container/dkabm:record/dcterms:extent\"/><xml-property name=\"dc.language\" override=\"true\" reverse=\"no\" spell-check=\"na\" value-converter=\"default\" xpath=\"/ting:container/dkabm:record/dc:language\"/><xml-property name=\"dc.date\" override=\"true\" reverse=\"no\" spell-check=\"na\" value-converter=\"default\" xpath=\"/ting:container/dkabm:record/dc:date\"/><xml-property name=\"dc.identifier\" override=\"true\" reverse=\"no\" spell-check=\"na\" value-converter=\"default\" xpath=\"/ting:container/dkabm:record/dc:identifier\"/><xml-property name=\"dc.publisher\" override=\"true\" reverse=\"no\" spell-check=\"na\" value-converter=\"default\" xpath=\"/ting:container/dkabm:record/dc:publisher\"/><xml-property name=\"ac.source\" override=\"true\" reverse=\"no\" spell-check=\"na\" value-converter=\"default\" xpath=\"/ting:container/dkabm:record/ac:source | ting:container/format\"/><xml-property index=\"un_tokenized\" name=\"phrase.title\" override=\"true\" reverse=\"no\" spell-check=\"na\" value-converter=\"phrase\" xpath=\"/ting:container/docbook:article/docbook:title | /ting:container/dkabm:record/dcterms:alternative| /ting:container/phrase/docbook:article/docbook:title | /ting:container/phrase/dkabm:record/dcterms:alternative\"/><xml-property index=\"un_tokenized\" name=\"phrase.creator\" override=\"true\" reverse=\"no\" spell-check=\"na\" value-converter=\"phrase\" xpath=\"/ting:container/docbook:article/docbook:info/docbook:author/docbook:personname/* | /ting:container/dkabm:record/dc:creator | /ting:container/dkabm:record/dc:contributor| /ting:container/phrase/docbook:article/docbook:info/docbook:author/docbook:personname/* | /ting:container/phrase/dkabm:record/dc:creator | /ting:container/phrase/dkabm:record/dc:contributor\"/><xml-property index=\"un_tokenized\" name=\"phrase.anyIndexes\" override=\"true\" reverse=\"no\" spell-check=\"na\" value-converter=\"phrase\" xpath=\"/ting:container/docbook:article/docbook:title | /ting:container/docbook:article/docbook:info/docbook:abstract/docbook:para | /ting:container/docbook:article/docbook:info/docbook:subjectset/docbook:subject/docbook:subjectterm | /ting:container/docbook:article/docbook:section/docbook:title | /ting:container/docbook:article/docbook:section/docbook:para| /ting:container/phrase/docbook:article/docbook:title | /ting:container/phrase/docbook:article/docbook:info/docbook:abstract/docbook:para | /ting:container/phrase/docbook:article/docbook:info/docbook:subjectset/docbook:subject/docbook:subjectterm | /ting:container/phrase/docbook:article/docbook:section/docbook:title | /ting:container/phrase/docbook:article/docbook:section/docbook:para\"/><xml-property index=\"un_tokenized\" name=\"phrase.description\" override=\"true\" reverse=\"no\" spell-check=\"na\" value-converter=\"phrase\" xpath=\"/ting:container/docbook:article/docbook:info/docbook:abstract/docbook:para| /ting:container/phrase/docbook:article/docbook:info/docbook:abstract/docbook:para\"/><xml-property index=\"un_tokenized\" name=\"phrase.subject\" override=\"true\" reverse=\"no\" spell-check=\"na\" value-converter=\"phrase\" xpath=\"/ting:container/docbook:article/docbook:info/docbook:subjectset/docbook:subject/docbook:subjectterm | /ting:container/dkabm:record/dc:subject| /ting:container/phrase/docbook:article/docbook:info/docbook:subjectset/docbook:subject/docbook:subjectterm | /ting:container/phrase/dkabm:record/dc:subject\"/><xml-property index=\"un_tokenized\" name=\"phrase.type\" override=\"true\" reverse=\"no\" spell-check=\"na\" value-converter=\"phrase\" xpath=\"/ting:container/dkabm:record/dc:type| /ting:container/phrase/dkabm:record/dc:type\"/><xml-property index=\"un_tokenized\" name=\"phrase.language\" override=\"true\" reverse=\"no\" spell-check=\"na\" value-converter=\"phrase\" xpath=\"/ting:container/dkabm:record/dc:language| /ting:container/phrase/dkabm:record/dc:language\"/><xml-property index=\"un_tokenized\" name=\"phrase.date\" override=\"true\" reverse=\"no\" spell-check=\"na\" value-converter=\"phrase\" xpath=\"/ting:container/dkabm:record/dc:date| /ting:container/phrase/dkabm:record/dc:date\"/><xml-property index=\"un_tokenized\" name=\"phrase.source\" override=\"true\" reverse=\"no\" spell-check=\"na\" value-converter=\"phrase\" xpath=\"/ting:container/dkabm:record/dc:source| /ting:container/phrase/dkabm:record/dc:source\"/><xml-property index=\"un_tokenized\" name=\"phrase.identifier\" override=\"true\" reverse=\"no\" spell-check=\"na\" value-converter=\"phrase\" xpath=\"/ting:container/dkabm:record/dc:identifier| /ting:container/phrase/dkabm:record/dc:identifier\"/><xml-property index=\"un_tokenized\" name=\"phrase.publisher\" override=\"true\" reverse=\"no\" spell-check=\"na\" value-converter=\"phrase\" xpath=\"/ting:container/dkabm:record/dc:publisher| /ting:container/phrase/dkabm:record/dc:publisher\"/><xml-property index=\"un_tokenized\" name=\"facet.creator\" override=\"true\" reverse=\"no\" spell-check=\"na\" value-converter=\"facet\" xpath=\"/ting:container/dkabm:record/dc:creator[not(@xsi:type='oss:sort')] | /ting:container/dkabm:record/dc:contributor\"/><xml-property index=\"un_tokenized\" name=\"facet.type\" override=\"true\" reverse=\"no\" spell-check=\"na\" value-converter=\"facet\" xpath=\"/ting:container/dkabm:record/dc:type\"/><xml-property index=\"un_tokenized\" name=\"facet.subject\" override=\"true\" reverse=\"no\" spell-check=\"na\" value-converter=\"facet\" xpath=\"/ting:container/dkabm:record/dc:subject[not(@xsi:type='dkdcplus:DK5')]\"/><xml-property index=\"un_tokenized\" name=\"facet.date\" override=\"true\" reverse=\"no\" spell-check=\"na\" value-converter=\"facet\" xpath=\"/ting:container/dkabm:record/dc:date\"/><xml-property index=\"un_tokenized\" name=\"facet.language\" override=\"true\" reverse=\"no\" spell-check=\"na\" value-converter=\"facet\" xpath=\"/ting:container/dkabm:record/dc:language[not(@*)]\"/><xml-property index=\"un_tokenized\" name=\"facet.geographic\" override=\"true\" reverse=\"no\" spell-check=\"na\" value-converter=\"facet\" xpath=\"/ting:container/dkabm:record/dcterms:spatial\"/><xml-property index=\"un_tokenized\" name=\"facet.period\" override=\"true\" reverse=\"no\" spell-check=\"na\" value-converter=\"facet\" xpath=\"/ting:container/dkabm:record/dcterms:temporal\"/><xml-property index=\"un_tokenized\" name=\"facet.fiction\" override=\"true\" reverse=\"no\" spell-check=\"na\" value-converter=\"facet\" xpath=\"/ting:container/dkabm:record/dc:subject[@xsi:type='dkdcplus:DBCS']\"/><xml-property index=\"un_tokenized\" name=\"facet.nonFiction\" override=\"true\" reverse=\"no\" spell-check=\"na\" value-converter=\"facet\" xpath=\"/ting:container/dkabm:record/dc:subject[@xsi:type='dkdcplus:DBCF']\"/><xml-property index=\"un_tokenized\" name=\"facet.music\" override=\"true\" reverse=\"no\" spell-check=\"na\" value-converter=\"facet\" xpath=\"/ting:container/dkabm:record/dc:subject[@xsi:type='dkdcplus:DBCM']\"/><xml-property index=\"un_tokenized\" name=\"facet.dk5\" override=\"true\" reverse=\"no\" spell-check=\"na\" value-converter=\"facet\" xpath=\"/ting:container/dkabm:record/dc:subject[@xsi:type='dkdcplus:DK5']\"/><xml-property index=\"un_tokenized\" name=\"sort.date\" override=\"true\" reverse=\"no\" spell-check=\"na\" value-converter=\"sort\" xpath=\"/ting:container/dkabm:record/dc:date[1]\"/><xml-property index=\"un_tokenized\" name=\"sort.creator\" override=\"true\" reverse=\"no\" spell-check=\"na\" value-converter=\"sort\" xpath=\"/ting:container/dkabm:record/dc:creator[@xsi:type='oss:sort'][1]\"/><xml-property index=\"un_tokenized\" name=\"sort.title\" override=\"true\" reverse=\"no\" spell-check=\"na\" value-converter=\"sort\" xpath=\"/ting:container/dkabm:record/dc:title[1]\"/><xml-property index=\"un_tokenized\" name=\"creator\" override=\"true\" reverse=\"no\" spell-check=\"na\" value-converter=\"facet\" xpath=\"/ting:container/dkabm:record/dc:creator | /ting:container/dkabm:record/dc:contributor\"/><xml-property index=\"un_tokenized\" name=\"date\" override=\"true\" reverse=\"no\" spell-check=\"na\" value-converter=\"facet\" xpath=\"/ting:container/dkabm:record/dc:date\"/><xml-property index=\"un_tokenized\" name=\"description\" override=\"true\" reverse=\"no\" spell-check=\"na\" value-converter=\"facet\" xpath=\"/ting:container/dkabm:record/dc:description | /ting:container/dkabm:record/dcterms:abstract\"/><xml-property index=\"un_tokenized\" name=\"format\" override=\"true\" reverse=\"no\" spell-check=\"na\" value-converter=\"facet\" xpath=\"/ting:container/dkabm:record/dc:format | /ting:container/dkabm:record/dcterms:extent\"/><xml-property index=\"un_tokenized\" name=\"identifier\" override=\"true\" reverse=\"no\" spell-check=\"na\" value-converter=\"facet\" xpath=\"/ting:container/dkabm:record/dc:identifier\"/><xml-property index=\"un_tokenized\" name=\"language\" override=\"true\" reverse=\"no\" spell-check=\"na\" value-converter=\"facet\" xpath=\"/ting:container/dkabm:record/dc:language[not(@*)]\"/><xml-property index=\"un_tokenized\" name=\"publisher\" override=\"true\" reverse=\"no\" spell-check=\"na\" value-converter=\"facet\" xpath=\"/ting:container/dkabm:record/dc:publisher\"/><xml-property index=\"un_tokenized\" name=\"source\" override=\"true\" reverse=\"no\" spell-check=\"na\" value-converter=\"facet\" xpath=\"/ting:container/dkabm:record/dc:source | /ting:container/dkabm:record/dcterms:isPartOf\"/><xml-property index=\"un_tokenized\" name=\"subject\" override=\"true\" reverse=\"no\" spell-check=\"na\" value-converter=\"facet\" xpath=\"/ting:container/dkabm:record/dc:subject\"/><xml-property index=\"un_tokenized\" name=\"title\" override=\"true\" reverse=\"no\" spell-check=\"na\" value-converter=\"facet\" xpath=\"/ting:container/dkabm:record/dc:title\"/><xml-property index=\"un_tokenized\" name=\"type\" override=\"true\" reverse=\"no\" spell-check=\"na\" value-converter=\"facet\" xpath=\"/ting:container/dkabm:record/dc:type\"/><xml-property index=\"un_tokenized\" name=\"relation\" override=\"true\" reverse=\"no\" spell-check=\"na\" value-converter=\"facet\" xpath=\"/ting:container/dkabm:record/dc:relation\"/><xml-property index=\"un_tokenized\" name=\"rights\" override=\"true\" reverse=\"no\" spell-check=\"na\" value-converter=\"facet\" xpath=\"/ting:container/dkabm:record/dc:rights\"/><xml-property index=\"un_tokenized\" override=\"true\" reverse=\"no\" spell-check=\"na\" xpath=\"/ting:container/ting:fedoraPid\"/><xml-property index=\"un_tokenized\" override=\"true\" reverse=\"no\" spell-check=\"na\" xpath=\"/ting:container/ting:fedoraNormPid\"/><xml-property index=\"un_tokenized\" override=\"true\" reverse=\"no\" spell-check=\"na\" xpath=\"/ting:container/ting:original_format\"/><xml-property index=\"un_tokenized\" override=\"true\" reverse=\"no\" spell-check=\"na\" xpath=\"/ting:container/ting:submitter\"/></xml-object></compass-core-mapping>";

    @Before
    public void setUp() throws Exception
    {
        // write example xml.cpm.xml to temporary file
        File cpmFile = File.createTempFile("opensearch_unittests_PhraseMap_", "_cpmFile");
        cpmFile.deleteOnExit();
        FileOutputStream fop = new FileOutputStream(cpmFile);
        if(cpmFile.exists())
        {
          fop.write(cpmData.getBytes());
          fop.flush();
          fop.close();
        }
        cpmFileName = cpmFile.getAbsolutePath();
        // get temporary filename for target file
        File tmp = File.createTempFile("opensearch_unittests_PhraseMap_", "_targetFile");
        tempFileName = tmp.getAbsolutePath();
        tmp.delete();
     }

    /**
     * Test of instance method, of class PhraseMap.
     */
   
    @Test
    public void testBuildPhraseMap() throws Exception
    {

        
        PhraseMap phraseMap = PhraseMap.instance(cpmFileName, tempFileName);

        File tempFile = new File(tempFileName);

       // get TempFileName content
        //String tempFileNameContent = "";

        byte[] buffer = new byte[(int) new File(tempFileName).length()];
        BufferedInputStream f = new BufferedInputStream(new FileInputStream(tempFileName));
        f.read(buffer);
        String tempFileNameContent = new String(buffer);
        assertEquals(tempFileNameContent, expectedCpm);
    }

  
    @Test
    public void testSingeltonPattern() throws Exception
    {
        PhraseMap phraseMap = PhraseMap.instance(cpmFileName, tempFileName);
        PhraseMap phraseMap2 = PhraseMap.instance(cpmFileName, tempFileName);
        assertSame(phraseMap, phraseMap2);
    }

 
    @Test
    public void tesstGetPhraseMap() throws Exception
    {
        PhraseMap phraseMap = PhraseMap.instance(cpmFileName, tempFileName);
        HashMap<XPathExpression, String> map = phraseMap.getPhraseMap("docbook");

        Set<XPathExpression> set = (Set<XPathExpression>)map.keySet();

        // TRIM PATHS ??????????
        // assert all expected paths are constructed and present
        assertTrue(map.containsValue("/ting:container/phrase/dkabm:record/dc:language"));
        assertTrue(map.containsValue("/ting:container/phrase/dkabm:record/dc:language"));
        assertTrue(map.containsValue("/ting:container/phrase/dkabm:record/dc:source"));
        assertTrue(map.containsValue("/ting:container/phrase/docbook:article/docbook:title "));
        assertTrue(map.containsValue("/ting:container/phrase/dkabm:record/dc:publisher"));
        assertTrue(map.containsValue("/ting:container/phrase/docbook:article/docbook:info/docbook:subjectset/docbook:subject/docbook:subjectterm "));
        assertTrue(map.containsValue("/ting:container/phrase/docbook:article/docbook:title "));
        assertTrue(map.containsValue("/ting:container/phrase/docbook:article/docbook:info/docbook:author/docbook:personname/* "));
        assertTrue(map.containsValue("/ting:container/phrase/dkabm:record/dc:identifier"));
        assertTrue(map.containsValue("/ting:container/phrase/dkabm:record/dc:subject"));
        assertTrue(map.containsValue("/ting:container/phrase/dkabm:record/dc:date"));
        assertTrue(map.containsValue("/ting:container/phrase/docbook:article/docbook:section/docbook:para"));
        assertTrue(map.containsValue("/ting:container/phrase/dkabm:record/dc:creator "));
        assertTrue(map.containsValue("/ting:container/phrase/dkabm:record/dc:type"));
        assertTrue(map.containsValue("/ting:container/phrase/docbook:article/docbook:info/docbook:subjectset/docbook:subject/docbook:subjectterm "));
        assertTrue(map.containsValue("/ting:container/phrase/docbook:article/docbook:info/docbook:abstract/docbook:para"));
        assertTrue(map.containsValue("/ting:container/phrase/dkabm:record/dcterms:alternative"));
        assertTrue(map.containsValue("/ting:container/phrase/dkabm:record/dc:contributor"));
        assertTrue(map.containsValue("/ting:container/phrase/docbook:article/docbook:section/docbook:title "));
        assertTrue(map.containsValue("/ting:container/phrase/docbook:article/docbook:info/docbook:abstract/docbook:para "));
    }
}