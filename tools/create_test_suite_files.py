#!/usr/bin/env python
# -*- coding: utf-8 -*-
# -*- mode: python -*-


# This file is part of opensearch.
# Copyright Â© 2009, Dansk Bibliotekscenter a/s, 
# Tempovej 7-11, DK-2750 Ballerup, Denmark. CVR: 15149043
#
# opensearch is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# opensearch is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with opensearch.  If not, see <http://www.gnu.org/licenses/>.


import sys
import os
import fnmatch


def write_text_to_file( fldr, className, fileTxt ):
    fileName = fldr + '/' + className + '.java'

    try:
        f = open( fileName, 'w')
        f.writelines( fileTxt )
        f.close()
    except IOError, ioe:
        sys.exit( "Could not open write for writing: %s"% ( ioe ) )


def create_test_suite_file_text( fldr, className, testNames ):
    fileTxt = []
    
    # Create package name
    packageName = fldr[ fldr.index( 'dk' ):].replace( '/', '.' )
    
    #  test classes
    test_classes = ""
    l = len( testNames ) - 1
    for tests in testNames[:l]:
        test_classes += """%s.class,
        """% tests
        
    test_classes += """%s.class"""% testNames[l]

    # Header text
    fileTxt.append( """/******************************************
 * THIS FILE HAS BEEN AUTOGENERATED USING *
 *                                        *
 *       create_test_suite_files.py       *
 ******************************************/

package %s;

import org.junit.runner.RunWith;
import org.junit.runners.Suite;


@RunWith(Suite.class)
@Suite.SuiteClasses(
    {
        %s
    }
)"""% ( packageName, test_classes ) )

    # Write class
    fileTxt.append( """
public class %s 
{
    // Leave class empty!
}"""% ( className ) )

    return fileTxt


def match( ptr, fldr, names ):
    tests = []
    fileTxt = ""

    # Consider only /tests folders
    if fnmatch.fnmatch( fldr, '*tests' ):
        for name in names:
            if name.endswith( ptr ): 
                # Names for suite classes
                tests.append( name.replace( '.java', '' ) )

        # Create suite classes if '*Test.java' (ptr) files exist
        if len( tests ) > 0:
            # Process 'tests' folders
            projectName = ""
            if fldr.endswith('/tests'):
                projectName = fldr.replace( '/tests', '' ).split('/').pop()
                className = projectName.upper() + 'TestSuite'
                fileTxt = create_test_suite_file_text( fldr, className, tests )
                write_text_to_file( fldr, className, fileTxt )
    
    
def delete_suite_files( ptr, folder, names ):
    if fnmatch.fnmatch( folder, '*tests' ):
        for name in names:
            if name.endswith( ptr ):
                fileName = folder + '/' + name
                os.remove( fileName )
    

def call_walk_clean( srcDir ):
    os.path.walk( srcDir, delete_suite_files, 'Suite.java' )
    print 'Old suite files have been deleted'


def call_walk_make( srcDir ):
    os.path.walk( srcDir, match, 'Test.java' )
    print 'Suite files successfully created!'


def main( arg_lst ):
    
    sourceDir = os.getcwd()

    if os.path.basename( sourceDir ) == 'tools':
        sourceDir = '../src/dk/dbc/opensearch'  
        #print sourceDir

    elif os.path.basename( sourceDir ) == 'trunk':
        sourceDir = 'src/dk/dbc/opensearch'
        #print sourceDir
    else:
        print '<ERROR>'
        print 'Current directory should be ~/.../opensearch/trunk/tools'
        sys.exit(2);

    if len(arg_lst) == 0: # default 
        call_walk_clean( sourceDir )
        call_walk_make( sourceDir )
        
    elif arg_lst[0] == 'clean':
        call_walk_clean( sourceDir )

    elif arg_lst[0] == 'make':
        call_walk_make( sourceDir )
    else:    
        print '<ERROR>'
        print 'Dont know how to handle argument ', arg_lst[0]
        sys.exit(2);

if __name__ == "__main__":
    main( sys.argv[1:])
